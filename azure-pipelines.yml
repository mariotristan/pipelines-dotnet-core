trigger:
  branches:
    include:
      - master

pr:
  branches:
    include:
      - master

variables:
  buildVersion: '1.0.$(Build.BuildId)'
  buildBranch: $(Build.SourceBranch)

stages:
- stage: Build
  displayName: 'Build & Package PR'
  condition: startsWith(variables['buildBranch'], 'refs/pull/')
  jobs:
  - job: BuildPR
    displayName: 'Validate PR Build'
    steps:
    - script: echo "ðŸ” Branch: $(buildBranch)"
      displayName: 'Debug Branch Ref'

    - script: echo "Building code from PR..."
      displayName: 'Build PR'

    - script: |
        echo "Packaging artifacts..."
        mkdir drop
        echo "$(buildVersion)" > drop/version.txt
      displayName: 'Package Artifacts'

    - publish: drop
      artifact: buildOutput

- stage: Deploy
  displayName: 'Deploy Merged PR to Main'
  dependsOn: Build
  condition: startsWith(variables['buildBranch'], 'refs/heads/master')
  jobs:
  - job: DeployJob
    steps:
    - download: current
      artifact: buildOutput

    - script: echo "Deploying build version $(buildVersion) from $(buildBranch)..."
      displayName: 'Deploy Build'

    - script: echo "Tagging release v$(buildVersion)..."
      displayName: 'Tag Release'
