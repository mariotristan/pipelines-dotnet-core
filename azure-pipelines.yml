trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

variables:
  buildVersion: '1.0.$(Build.BuildId)'

stages:
- stage: Build
  displayName: 'Build & Package'
  condition: startsWith(variables['Build.SourceBranch'], 'refs/pull/')
  jobs:
  - job: BuildPR
    displayName: 'Validate PR Build'
    steps:
    - script: echo "Building PR code..."
      displayName: 'Build PR'
    
    - script: |
        echo "Packaging artifacts..."
        mkdir drop
        echo "$(buildVersion)" > drop/version.txt
      displayName: 'Package Artifacts'

    - publish: drop
      artifact: buildOutput

- stage: Deploy
  displayName: 'Deploy Post-Merge'
  dependsOn: Build
  condition: startsWith(variables['Build.SourceBranch'], 'refs/heads/main')
  jobs:
  - job: DeployJob
    steps:
    - download: current
      artifact: buildOutput

    - script: echo "Deploying version $(buildVersion)...
